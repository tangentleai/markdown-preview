# Change: 系统修复 WYSIWYG 渲染缺陷并优化编辑交互体验

## Why
当前 WYSIWYG 编辑模式在分割线、数学公式、表格溢出、标题大纲与整体布局上存在可见缺陷，影响可读性、编辑效率与界面一致性。需要一次系统化变更，在不破坏既有编辑能力的前提下修复渲染问题并提升交互体验。

## Problem Statement
- `---` 在 WYSIWYG 模式下未稳定渲染为水平分割线，导致 Markdown 语义与视觉结果不一致。
- 数学公式存在渲染失败或回退显示问题，复杂 LaTeX 在不同屏幕下显示稳定性不足。
- 数学公式缺少就地编辑体验，无法像 Mermaid/PlantUML 一样点击后挂载专用编辑器。
- 宽表格超出可视区时缺乏可预期的横向滚动容器与提示，阅读体验受损。
- 左侧标题大纲对长标题使用截断，结构信息丢失，可读性差。
- 编辑区与大纲区布局比例、对齐方式、拖拽联动与编辑态视觉反馈仍不理想。

## What Changes
- 修复 `---` 分割线渲染链路，确保语法识别、DOM 输出与样式表现一致。
- 完善数学公式渲染能力，支持标准 LaTeX 语法，并覆盖给定验证用例。
- 增加数学公式交互式编辑：点击公式后在公式上方挂载 Monaco 编辑器，内容与渲染实时同步。
- 增加表格溢出自动检测与横向滚动容器封装，并提供可感知的横向滚动提示。
- 优化标题大纲文本排版策略：长标题自动换行，保留层级缩进并提升多行可读性。
- 重构 WYSIWYG 布局参数：大纲贴左、编辑区居中、默认宽度符合视觉比例，并支持大纲宽度拖拽联动。
- 移除编辑态蓝色高亮框，改为更低干扰的焦点反馈方案。

## Success Metrics
- 功能正确性：分割线、数学公式、表格滚动、大纲换行、布局拖拽联动均可稳定复现。
- 一致性：在桌面与移动端断点下，数学公式与布局行为保持一致。
- 性能：公式连续输入时主线程长任务 `< 50ms`，中长文档场景无明显输入阻塞。
- 可用性：主要交互路径中不出现焦点丢失、编辑错位或不可恢复状态。

## Confirmed Decisions
- 公式引擎策略：默认沿用当前实现；若给定测试用例无法正确渲染，允许替换为功能更全面的引擎。
- 公式失败回退：渲染失败时显示原始 LaTeX 文本，不破坏周围内容。
- 公式编辑并发：同一时刻仅允许一个 Monaco 编辑器实例。
- 同步策略：公式编辑采用防抖同步渲染（阈值见设计文档）。
- 表格溢出提示：使用图标提示横向可滚动内容。
- 大纲长标题策略：最多显示 3 行，超出后截断。
- 布局比例：右侧编辑区目标宽度占可视区 68%。
- 拖拽状态：大纲宽度不做本地持久化。
- 移动端策略：大纲采用抽屉模式。
- 焦点样式：移除蓝色高亮框，改为轻阴影焦点态。
- 验收方式：沿用既有 OpenSpec 任务与验证包流程。

## Scope
### In Scope
- WYSIWYG 模式内与渲染、排版、交互直接相关的前端逻辑与样式层。
- 数学公式渲染与交互编辑能力（Monaco 挂载/卸载、实时同步）。
- 表格溢出容器与提示、大纲换行策略、布局与响应式行为。

### Out of Scope
- 新增数学语法扩展（超出标准 LaTeX 的自定义宏系统）。
- 非 WYSIWYG 模式下的全量布局重构。
- 与本次问题无关的编辑器内核替换或文档模型重写。

## Impact
- Affected specs: `wysiwyg-markdown-editor`
- Affected code:
  - `src/components/WysiwygEditor*` 与相关渲染/交互模块
  - 数学公式、表格容器、大纲面板、布局管理与样式文件
  - 相关单元测试、组件测试、GUI MCP 验证 runbook

## Risks and Mitigations
- 数学公式实时渲染导致性能抖动: 引入渲染节流/防抖与增量刷新策略。
- Monaco 挂载导致焦点竞争: 复用 Mermaid/PlantUML 既有 mount/dismiss 生命周期模式。
- 布局拖拽影响响应式稳定性: 使用最小/最大宽度约束与断点下回退策略。
- 表格横向容器影响纵向滚动: 通过事件传播与容器层级隔离保证垂直滚动不被截断。

## Rollout / Rollback
- Rollout: 采用分阶段交付（渲染正确性 -> 公式交互 -> 表格/大纲/布局），每阶段附带回归验证包。
- Rollback: 保留模块化回退能力，若某一阶段出现回归，可单独回退该模块并保持核心编辑流程可用。

## Quality Assurance Strategy
- 单元/组件测试覆盖渲染规则、交互状态机与样式类名分支。
- GUI MCP 回归覆盖公式编辑、表格溢出、拖拽布局与响应式断点。
- 增加性能基线检测（渲染耗时与输入响应）并设置回归阈值。
- 通过验收包沉淀一键复现路径，确保问题可审计、可回放。

## Open Questions
- Open Question: 公式防抖渲染的具体默认时长（例如 150ms/200ms/300ms）尚未最终确认。
- Open Question: 大纲拖拽宽度的最小值/最大值（px）尚未最终确认。
