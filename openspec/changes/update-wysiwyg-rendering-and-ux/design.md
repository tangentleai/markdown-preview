# WYSIWYG 渲染修复与交互优化设计

## Context
本次变更聚焦 WYSIWYG 编辑模式中已暴露的渲染缺陷与交互断点，目标是在保持现有文档编辑链路稳定的前提下，补齐分割线、数学公式、表格溢出、大纲展示与布局联动能力。

## Goals / Non-Goals
- Goals:
  - 修复分割线与数学公式渲染正确性问题。
  - 实现数学公式点击编辑与实时预览同步。
  - 优化宽表格的横向滚动承载与提示。
  - 提升大纲长标题可读性与布局清晰度。
  - 建立可拖拽、可响应式的编辑区与大纲区联动布局。
- Non-Goals:
  - 不替换编辑器技术栈。
  - 不引入跨文档的状态持久化系统。
  - 不扩展非标准数学语法方言。

## Technical Plan

### 1) 分割线渲染修复
- 在 Markdown 到 WYSIWYG 的解析与渲染层确认 `---` 触发路径，保证输出标准 `<hr>` 结构。
- 统一编辑态与预览态样式令牌，避免 `<hr>` 被通用样式覆盖为不可见。
- 增加针对行首/前后空行场景的回归用例，防止解析歧义回归。

### 2) 数学公式渲染能力完善
- 检查并修复数学 AST 节点到渲染组件的映射链路，确保块级与行内公式均可渲染。
- 对 LaTeX 输入执行安全的预处理与错误兜底，保证失败时不破坏周围内容结构。
- 引擎策略: 默认沿用现有引擎；若给定验证样例无法正确渲染，切换到功能更完整的候选引擎。
- 使用如下基准用例验证:

```tex
\[
\text{MOM}_{i,t} = \frac{P_{i,t-1}}{P_{i,t-1-N}} - 1
\]
```

- 响应式策略: 公式容器支持缩放/换行回退与溢出滚动回退，确保小屏可读。
- 失败回退策略: 公式渲染失败时展示原始 LaTeX 文本，保留可编辑性。
- 性能策略: 对连续输入采用防抖渲染与缓存编译结果，降低重复计算；主线程长任务阈值 `< 50ms`。

### 3) 数学公式交互式编辑
- 交互模型: 点击公式节点进入编辑态，在公式上方挂载 Monaco 实例。
- 生命周期复用 Mermaid/PlantUML 的 `mountMonacoEditors` 思路:
  - mount: 定位公式节点并挂载编辑器。
  - sync: 编辑器内容变更触发公式实时重渲染。
  - dismiss: 点击外部、Esc、模式切换时释放实例并回写内容。
- 焦点规则: 进入编辑态后键盘焦点归 Monaco；退出时恢复到公式块位置。
- 并发规则: 同一时刻只允许一个 Monaco 实例，点击新公式时自动关闭旧实例并切换。

### 4) 表格溢出处理
- 在渲染后测量表格宽度与编辑区可视宽度，超阈值时自动包裹 scrollview 容器。
- scrollview 仅承担横向滚动，表格内部纵向交互通过原始元素处理，避免滚动冲突。
- 添加图标视觉提示标记存在横向隐藏内容，并根据滚动状态更新提示可见性。

### 5) 左侧标题大纲优化
- 将标题文本策略由单行截断改为自动换行。
- 按标题层级设置缩进变量并保留层次结构。
- 为多行标题设置最小行高、段间距和点击热区，保证可读且易操作。
- 换行上限为 3 行，超出后执行截断显示。

### 6) 编辑器布局调整
- 大纲区域贴紧左侧边缘，减少无效留白。
- 编辑内容区使用可配置宽度与居中容器，目标宽度为编辑器可视区的 68%。
- 提供大纲面板拖拽宽度手柄，宽度变化实时驱动编辑区可用宽度和居中偏移更新。
- 拖拽宽度状态仅在当前会话生效，不进行本地持久化。
- 响应式断点下设置宽度上下限与折叠策略，避免小屏布局挤压。
- 移动端采用大纲抽屉策略。
- 编辑态去除蓝色高亮边框，改为轻阴影焦点态样式。

## Testing and Validation
- Unit/Component:
  - 分割线解析与 `<hr>` 渲染断言。
  - 数学公式渲染成功/失败回退断言。
  - 表格 overflow 检测与 scrollview 包裹逻辑断言。
  - 大纲多行换行与层级缩进样式断言。
- GUI MCP Runbook:
  - 公式点击挂载 Monaco、实时同步与 dismiss 路径。
  - 响应式断点下公式显示、布局拖拽联动与表格滚动提示。
  - 编辑态焦点样式验证（无蓝色高亮框）。
- Performance:
  - 对连续公式编辑、长文档和宽表格场景采集渲染耗时与输入延迟。

## Quality Gates
- `openspec validate <change-id> --strict --no-interactive` 必须通过。
- 新增测试在 CI 中稳定通过，无 flaky 结果。
- GUI 关键路径（公式编辑、布局拖拽、表格横向滚动）具备可复现实证。

## Assumptions and Open Questions
- Assumption: 公式编辑防抖默认值暂定 200ms，后续可根据测试数据在实现中调整。
- Open Question: 大纲拖拽宽度最小值/最大值尚未确认，需要在实现前确定。

## Rollout and Rollback
- Rollout: 按模块逐步合入（渲染修复 -> 交互编辑 -> 布局与大纲优化），每步配套回归。
- Rollback: 保留开关与回退点，任一模块出现严重回归可独立回滚，不阻断核心编辑流程。
