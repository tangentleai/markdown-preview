# Change: 优化 WYSIWYG 文档查找与替换体验

## Why
当前 WYSIWYG 编辑器已有基础查找替换，但在键盘闭环、结果定位反馈、匹配策略配置和工具栏可用性上存在断点，导致长文档定位和批量替换效率不足。

## Goals
- 提升命中跳转准确率，确保上下导航定位结果与用户预期一致。
- 提升替换正确率，确保替换当前/替换全部行为可预测且结果可验证。
- 提升无匹配时提示一致性，统一展示 `0/N` 并禁用不可执行操作。

## What Changes
- 支持 `Ctrl+F` 与 `Cmd+F` 打开查找；当编辑区有选中文本时，按快捷键将选区做纯文本归一化后写入查找词。
- 查找输入框支持 Enter 查找下一个；新增“查找上一个”按钮并支持循环回绕。
- 支持 `Esc` 在查找栏任意输入焦点状态下统一关闭查找栏并恢复编辑焦点。
- 上下命中切换时采用最小滚动策略（仅当当前命中不可见时滚动），并采用“全部命中淡高亮 + 当前命中强高亮”。
- 增加匹配选项：区分大小写、整词匹配、正则模式（JS RegExp，支持 `i/m`；全局由查找流程控制）。
- “区分大小写”按钮默认关闭：关闭时始终不区分大小写，开启后强制区分大小写。
- 当正则模式开启时，自动禁用“整词匹配”选项。
- 查找栏默认仅展示查找能力；通过模式切换按钮进入替换模式后显示替换输入框和“替换当前/替换全部”按钮；关闭查找栏后下次打开重置为默认查找模式。
- 使用 iconfont MCP 流程统一替换工具栏按钮图标（查找上一个、查找下一个、替换当前、替换全部、关闭、区分大小写、查找整个单词）。

## In Scope
- 单文档内查找/替换交互增强（键盘、按钮、匹配选项、命中定位与高亮反馈）
- 查找/替换模式切换与默认折叠替换区
- iconfont 图标化与现有 UI 风格统一

## Out of Scope
- 跨文件查找
- 查找历史/最近替换模板
- 独立搜索统计面板

## Success Metrics
- 命中跳转准确率：在回归样例中，上下导航命中位置与期望位置一致率达到 100%。
- 替换正确率：替换当前/替换全部在回归样例中的结果与预期一致率达到 100%。
- 无匹配提示一致性：无匹配场景统一展示 `0/N`，且上下导航和替换按钮均不可执行。

## Impact
- Affected specs: `wysiwyg-markdown-editor`
- Affected code:
  - `src/components` 下 WYSIWYG 查找/替换工具栏与交互状态管理
  - 编辑器命中索引计算、定位滚动、高亮渲染逻辑
  - 键盘事件处理（`Ctrl+F` / `Cmd+F` / `Enter` / `Esc`）
  - 正则匹配选项与异常处理
  - iconfont 资源接入与按钮样式

## Rollout / Rollback
- Rollout: 在现有 WYSIWYG 查找能力上渐进增强，默认启用新查找栏交互。
- Rollback: 如出现匹配或替换回归，可快速回退到旧查找栏交互实现并保留编辑核心能力。

## Risks
- 正则匹配引入异常输入风险（非法表达式）可能导致交互中断。
- 命中高亮与编辑区 DOM 同步不当可能造成定位漂移。
- 快捷键冲突可能影响既有编辑行为。

## Open Questions
- 暂无。
