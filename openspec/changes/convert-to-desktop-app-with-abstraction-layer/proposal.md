# Change: 基于前端项目产出桌面应用并引入可复用抽象层

## Why
当前项目仅提供浏览器运行形态，无法满足离线使用、本地文件集成和桌面分发场景。为了避免为桌面版重复实现核心逻辑，需要先重构出平台无关的抽象层，让前端版与桌面版共享同一套文档、渲染与编辑能力。

## Goals
- 面向技术写作者提供桌面形态，满足本地文件“打开、编辑、保存”核心闭环。
- 在桌面版补齐文件能力：打开/保存、另存为、最近文件、拖拽打开。
- 桌面版保持与 Web 版全部编辑能力兼容，不引入行为降级。
- 保持 UI 渲染观感美观，并控制首次渲染时间。

## Success Metrics
- 首次渲染时间达到可接受范围并可被自动化采集（基线与阈值在实现阶段固化到测试脚本）。
- 桌面端文件闭环能力可复现通过：打开、编辑、保存、另存为、最近文件、拖拽打开。
- Web/Desktop 编辑能力一致性回归用例通过率达到 100%。

## What Changes
- 新增桌面应用运行形态，基于现有 React + TypeScript 代码产出可安装桌面版本。
- 将现有业务逻辑重构为平台无关 core 层，UI 与平台适配层只保留装配与调用职责。
- 引入 Web 与 Desktop 双适配器，统一文件读写、窗口交互、系统能力调用接口。
- 建立双端一致性保障：同一输入在 Web 与 Desktop 保持渲染与编辑结果一致。
- 完善构建与发布流程，支持 Web 构建与桌面打包并行维护。

## Impact
- Affected specs: markdown-preview
- Affected code:
  - `src/App.tsx`
  - `src/components/MarkdownPreview.tsx`
  - `src/components/WysiwygEditor.tsx`
  - `src/utils/`
  - `package.json`
  - `vite.config.ts`
  - 新增桌面端入口与平台适配目录

## In Scope
- 重构出平台无关抽象层（文档模型、渲染管线、查找替换、文件服务接口）
- 接入桌面壳并完成最小可用桌面版本（打开、编辑、预览、保存、另存为、最近文件、拖拽打开）
- 建立跨平台能力边界与依赖约束
- 增加针对 core 层与平台适配层的自动化测试
- 首发平台为 macOS

## Out of Scope
- 云同步与多人协作
- 插件市场与扩展生态
- 移动端应用
- 自动更新与增量发布平台建设
- Windows/Linux 正式支持（作为后续里程碑）

## Risks & Mitigations
- 架构重构风险：拆分不当可能造成现有功能回归
  - 缓解：先抽接口再迁移实现，保留兼容层并增加回归测试
- 平台能力差异风险：桌面与浏览器文件/权限模型不同
  - 缓解：通过 adapter 隔离差异，禁止业务层直接依赖平台 API
- 构建复杂度风险：双端构建链路可能增加维护成本
  - 缓解：统一脚本入口并在 CI 中并行验证 Web/Desktop 构建

## Rollout / Rollback
- Rollout:
  - 提供 Web 构建与桌面打包命令，纳入同一项目脚本入口。
  - macOS 首发发布桌面安装产物。
- Rollback:
  - 若桌面构建或运行不稳定，回退到仅 Web 发布路径，桌面产物停止分发。
  - 保留 core 分层改造成果，避免对 Web 现网能力造成回滚之外影响。

## Open Questions
- Open Question: 首次渲染时间阈值是否采用固定值（例如 <= 500ms）或采用“相对当前基线不退化”策略？
