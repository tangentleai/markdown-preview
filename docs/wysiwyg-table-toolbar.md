# WYSIWYG 模式下表格悬浮工具栏（尺寸/对齐/删除）需求说明

## 范围与目标
- 范围：在 WYSIWYG 编辑模式下，用户点击表格后，在表格上方显示悬浮工具栏；提供表格尺寸（行×列）调整、表格整体对齐（左/中/右）与删除表格能力。
- 目标：
  - 提升表格编辑效率与可发现性，满足常用操作一步达成。
  - 与 Markdown 文档持久化规则一致且可逆（撤销/重做完整工作）。
  - 稳定、不遮挡内容、对大表格/小屏保持可用与可访问性。

## 设计概览
- 触发：单击表格任意位置（或键盘聚焦至表格时），显示悬浮工具栏。
- 定位：工具栏以表格外框顶部为锚点，默认居左对齐；视口边缘溢出时自动翻转/居中以保证完全可见。
- 结构：左侧为“行×列网格选择器”，其右侧依次是“左对齐”“居中”“右对齐”；最右为“删除表格”按钮。
- 关闭：点击编辑区空白处、滚动至表格完全离开视口、Esc、切换到非表格选区时关闭；关闭后不改变当前选区（仍在表格内除非删除）。
- 层级：以 `z-index` 高于表格内容但低于全局浮层（如菜单/对话框）。滚动时位置随之更新，无明显抖动。

## 功能详解

### 1）尺寸调整（行×列网格选择器）
- 网格：默认显示 3×3 的预览网格；鼠标移动时按所到单元格进行高亮预览，并在网格底部实时显示“R × C”（如 “8 × 12”）。
- 动态扩展：当鼠标接近网格右/下边缘且当前表格更大时，预览网格可按需延展（每次增量 5）。
- 确认交互：
  - 单击预览网格中的某个单元格 → 应用该尺寸（行=所选行数，列=所选列数）。
  - 键盘在网格获得焦点后可用方向键移动预选尺寸，Enter 确认，Esc 退出。
- 行列上限：单次设置最大 `200 × 40`（行 × 列）；当超过上限时显示非活跃态并给出提示。
- 缩小裁剪规则：
  - 若缩小导致“被移除的行/列”中存在非空内容，弹出确认（一次性）：提示“缩小将裁剪表格内容，可撤销；是否继续？”确认后执行；取消则不变。
  - 表头规则：第二行（分隔线）及第一行（表头）始终保留，缩小列时一并裁剪对应列。
- 应用结果：
  - 扩大：在表尾追加空白行/列；新增单元格为占位空白。
  - 缩小：从表尾开始裁剪多余行/列；与 Markdown 源映射一致（见“Markdown 持久化”）。
- 撤销/重做：作为单一原子操作入栈；撤销恢复裁剪内容。

### 2）表格对齐（左/中/右）
- 行为：设置表格作为“区块”在编辑区内的整体对齐方式，三者互斥。
- 初始态：默认“左对齐”。
- 状态可见性：当前选中对齐按钮以选中态显示；再点击同一项不取消（始终保持一种对齐）。
- 持久化与渲染：
  - Markdown 源：在表格块前插入或更新一行注释标记  
    `<!-- table:align=left|center|right -->`  
    与表格内容一起保存、可被再次解析。
  - WYSIWYG/预览：渲染 `<table>` 外层包裹容器添加 `align-left|align-center|align-right` 类；样式等价于：
    - `align-left`：`margin-left: 0; margin-right: auto;`
    - `align-center`：`margin-left: auto; margin-right: auto;`
    - `align-right`：`margin-left: auto; margin-right: 0;`
- 兼容性：若文档中已有该注释标记，则工具栏应同步其状态；删除表格时一并移除标记。

### 3）删除表格
- 行为：删除当前表格整体（含前置对齐注释标记），保留周围段落。
- 确认：当表格包含非空内容时，进行一次性确认；空表格直接删除。
- 焦点：删除后将光标定位到被删除表格位置的前一个可编辑块末尾；若不存在，创建一段空段落并聚焦。
- 撤销：一次撤销恢复表格与其内容、对齐标记。

## Markdown 持久化与解析
- 对齐标记：
  - 插入位置：紧邻表格前一行，仅作用于其后的第一个表格块。
  - 语法示例：
    ```md
    <!-- table:align=center -->
    | 列1 | 列2 |
    | --- | --- |
    |  1  |  2  |
    ```
  - 解析策略：加载时扫描文档；遇到该注释则为后续第一个表格节点附加对齐属性并移除此注释在编辑视图中的可见性；保存时若节点存在对齐属性则在其前输出注释。
- 尺寸变更：
  - 扩大列：为每行在行尾追加 `| 空白` 单元格；若缺少行末管道，按统一规则补全。
  - 缩小列：逐行裁剪末尾单元格；确保表头分隔行（`| --- |`）列数与表头一致。
  - 扩大行：在表尾依次追加 `| ... |` 的空白行。
  - 缩小行：从表尾开始删除行，保留表头与分隔行。
  - 任何变更都保持 Markdown 表格结构合法（列数对齐、分隔线存在）。

## 可访问性
- 键盘支持：工具栏可 Tab 聚焦；网格支持方向键移动、Enter 确认、Esc 关闭；对齐按钮为 `role="button"` 并可用空格/Enter 切换；删除按钮可用 Enter 触发。
- ARIA：
  - 工具栏容器：`role="toolbar"`，`aria-label="表格工具栏"`。
  - 网格：`role="grid"`，当前尺寸以 `aria-live="polite"` 暗示。
  - 删除确认：标准对话框语义，提供描述与聚焦管理。
- 对比度与命中面积：按钮最小可点击面积 32×32px；高对比度主题可见。

## 性能与技术实现建议
- 定位：优先 `position: fixed` + 监听 `scroll/resize`/`selectionchange` 计算锚点 `getBoundingClientRect()`；必要时使用 `ResizeObserver` 监听表格尺寸变更。
- 可见性：当表格顶部超出视口或被遮挡时自动隐藏；进入视口重新显示（含阈值避免抖动）。
- 事件节流：滚动与尺寸变更回调采用节流（16–32ms），保证流畅。
- 样式：工具栏在浅/深色主题下均可用；避免覆盖表格第一行内容，可在定位时增加 8–12px 的顶部外边距。

## 埋点（可选）
- `table_toolbar_open`：打开工具栏；参数：表格尺寸、是否在视口顶部翻转。
- `table_resize`：尺寸调整；参数：旧尺寸、新尺寸、是否触发裁剪确认。
- `table_align`：调整对齐；参数：对齐方式。
- `table_delete`：删除表格；参数：是否确认、单元格数量。
- `table_toolbar_close`：关闭原因（点击外部/滚动/Esc/完成操作）。

## 验收标准
- 点击表格后 100ms 内工具栏出现且位置正确，不遮挡首行内容。
- 网格预览与尺寸标签符合预期；Enter/Esc/方向键可用。
- 增大/缩小行列后，Markdown 源结构合法；缩小含内容时出现一次性确认。
- 对齐设置在 WYSIWYG 与预览态一致；保存/重新打开后保持一致（注释标记存在且正确）。
- 删除表格后焦点定位合理；撤销/重做恢复正确。
- 工具栏在 320px 宽设备与放大 200% 情况下仍可操作。

## 风险与边界
- 极大表格（>100×40）在尺寸变动时可能引发光标重排卡顿：通过批量 DOM 操作与虚拟更新降低风险。
- Markdown 表格不支持单元格合并：本功能仅针对规则矩形表格，不处理合并单元格场景。
- 若用户手动编辑注释标记格式错误，将在解析阶段忽略该标记并回退为左对齐。

## 迭代与扩展（后续）
- 在工具栏中补充“插入/删除单行/单列”“表头切换”“列对齐方式”等。
- 将尺寸调整的“缩小确认”细化至“只提醒一次/本次不再提醒”的体验。
- 支持多张表格同时存在时的就近准则与快捷键快速唤起（如 Alt+T）。

本需求落地后，表格的日常编辑（尺寸、对齐与删除）可在无上下文切换的情况下完成，并与 Markdown 源持久化保持一致，降低学习成本并提升编辑效率。 
